name: artifacts

on:
  workflow_dispatch:
  push:
    branches: [main]
  schedule:
    - cron: '30 */12 * * *'

jobs:
  packages-list:
    runs-on: ubuntu-latest
    outputs:
      matrix: "${{ steps.set-matrix.outputs.matrix }}"
    steps:
      - uses: actions/checkout@v6.0.2
      - id: set-matrix
        run: |
          set -ue
          matrix=$(jq --compact-output '.' ./packages.json)
          printf "matrix=%s" "$matrix" >> $GITHUB_OUTPUT
          echo $matrix
  build-vendor:
    runs-on: ubuntu-latest
    needs: [packages-list]
    strategy:
      fail-fast: true
      matrix:
        # PN PV SRC_URI S
        package: ${{ fromJson(needs.packages-list.outputs.matrix) }}
    name: "${{ matrix.package.PN }}-${{ matrix.package.PV }}"
    steps:
      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v6.0.1

      - name: cache package
        id: cache-package
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: dep-archives/
          key: package-${{ matrix.package.PN }}-${{ matrix.package.PV }}

      - name: make-vendortarball
        if: steps.cache-package.outputs.cache-hit != 'true'
        run: |
          export PN="${{ matrix.package.PN }}"
          export PV="${{ matrix.package.PV }}"
          export SRC_URI="${{ matrix.package.SRC_URI }}"
          export S="${{ matrix.package.S }}"
          ${GITHUB_WORKSPACE}/make-vendor.sh "${PN}" "${PV}" "${SRC_URI}" "${S}"
      - name: archive artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: "${{ matrix.package.PN }}-${{ matrix.package.PV }}"
          path: |
            dep-archives/
  push:
    if: ${{ github.event_name != 'schedule' }}
    runs-on: ubuntu-latest
    needs: build-vendor
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # 6.0.1
      - name: download artifacts
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
        with:
          path: dep-archives
      - name: gh
        run: |
          gh release delete v0.0.0 --cleanup-tag --yes || true
          gh release create v0.0.0 --latest
          find "${PWD}"/dep-archives/* -type f -exec gh release upload v0.0.0 '{}' --clobber \;
          gh release edit v0.0.0 --draft=false
        env:
            GH_TOKEN: ${{ github.token }}
